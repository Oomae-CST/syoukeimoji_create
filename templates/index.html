<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>甲骨文字ジェネレーター</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }

    .image-container {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 15px;
      flex-wrap: wrap; /* 狭い画面では折り返し */
    }

    .image-box {
      flex: 1;
      text-align: center;
      min-width: 220px;
    }

    .image-box img {
      width: 250px;   /* 元画像用デフォルトサイズ */
      height: 250px;
      object-fit: contain;
      border: 1px solid #ccc;
      background: #f9f9f9;
      margin-top: 5px;
    }

    /* 生成画像を少し小さく表示 */
    #result {
      width: 200px;
      height: 200px;
    }

    h1 {
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>画像から特徴抽出 → 甲骨文字風生成</h1>

  <h2>1. 画像アップロードして特徴抽出</h2>
  <input type="file" id="imageInput">
  <button onclick="extractFeatures()">特徴抽出</button>

  <!-- 横並び表示 -->
  <div class="image-container">
    <div class="image-box">
      <strong>アップロードした元画像</strong><br>
      <img id="originalImage">
    </div>
    <div class="image-box">
      <strong>生成結果</strong><br>
      <img id="result">
    </div>
  </div>

  <h2>2. 抽出された特徴</h2>
  <ul id="features-list"></ul>

  <button onclick="generateImage()">この特徴で生成</button>

  <script>
    let currentImageFile = null;
    let currentFeatures = [];

    async function extractFeatures() {
      const input = document.getElementById("imageInput");
      if (!input.files.length) {
        alert("画像を選択してください");
        return;
      }
      currentImageFile = input.files[0];

      // 元画像プレビュー表示
      const reader = new FileReader();
      reader.onload = e => {
        document.getElementById("originalImage").src = e.target.result;
      };
      reader.readAsDataURL(currentImageFile);

      const formData = new FormData();
      formData.append("image", currentImageFile);

      const res = await fetch("/features", {
        method: "POST",
        body: formData
      });
      const data = await res.json();
      currentFeatures = data.features || [];

      const container = document.getElementById("features-list");
      container.innerHTML = "";
      currentFeatures.forEach(f => {
        const li = document.createElement("li");
        li.innerHTML = `<label><input type="checkbox" value="${f}"> ${f}</label>`;
        container.appendChild(li);
      });
    }

    async function generateImage() {
      if (!currentImageFile) {
        alert("まず画像をアップロードしてください");
        return;
      }
      const checked = Array.from(document.querySelectorAll("#features-list input:checked"))
                           .map(el => el.value);
      if (checked.length === 0) {
        alert("特徴を選択してください");
        return;
      }

      const formData = new FormData();
      formData.append("image", currentImageFile);
      checked.forEach(f => formData.append("features", f));

      const res = await fetch("/convert", {
        method: "POST",
        body: formData
      });
      const data = await res.json();
      if (data.image) {
        document.getElementById("result").src = data.image;
      } else {
        alert("生成失敗: " + (data.error || "不明なエラー"));
      }
    }
  </script>
</body>
</html>
